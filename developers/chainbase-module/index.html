
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://tronprotocol.github.io/documentation-zh/developers/chainbase-module/">
      
      
        <link rel="prev" href="../code-structure/">
      
      
        <link rel="next" href="../network-module/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.8">
    
    
      
        <title>Chainbase - java-tron</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8608ea7d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="custom">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chainbase-tron" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="java-tron" class="md-header__button md-logo" aria-label="java-tron" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            java-tron
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Chainbase
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/tronprotocol/documentation-zh" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="java-tron" class="md-nav__button md-logo" aria-label="java-tron" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    java-tron
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tronprotocol/documentation-zh" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    java-tron入门
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            java-tron入门
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/getting_started_with_javatron/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    入门
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    使用java-tron
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            使用java-tron
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using_javatron/installing_javatron/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    部署
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using_javatron/backup_restore/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    备份和恢复
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using_javatron/litefullnode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    轻节点
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using_javatron/private_network/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    私链网络
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    事件订阅
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            事件订阅
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/event/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    概览
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/use-native-queue/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内置消息队列订阅
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/use-mongodb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mongodb 事件订阅插件
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/use-kafka/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kafka 事件订阅插件
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/database/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    数据库配置
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using_javatron/connecting_to_tron/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    网络连接
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using_javatron/metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    节点监控
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../using_javatron/toolkit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    节点维护工具
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    API接口
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API接口
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/http/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTTP 接口
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/rpc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    gRPC 接口
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/json-rpc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    jsonRPC 接口
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    核心协议
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            核心协议
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mechanism-algorithm/dpos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    波场共识
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mechanism-algorithm/sr/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    超级代表
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mechanism-algorithm/account/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    账户模型
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mechanism-algorithm/resource/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    资源模型
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contracts/contract/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    智能合约
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mechanism-algorithm/system-contracts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系统合约
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mechanism-algorithm/dex/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    去中心化交易所
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mechanism-algorithm/multi-signatures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    账户权限管理
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    java-tron开发
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            java-tron开发
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../java-tron/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开发者指南
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tips/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TIPs工作流程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../issue-workflow/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Issue工作流程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../governance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    治理流程
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../run-in-idea/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    配置IDE开发环境
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../demo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开发示例
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_7" checked>
        
          
          <label class="md-nav__link" for="__nav_6_7" id="__nav_6_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    核心模块
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6_7">
            <span class="md-nav__icon md-icon"></span>
            核心模块
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../code-structure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    模块结构
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Chainbase
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Chainbase
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item ">
  <a href="#_1" class="md-nav__link" >
    <span class="md-ellipsis">
      概览
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item has-children">
  <a href="#_2" class="md-nav__link" onclick="toggleChildren(event)" aria-expanded="false">
    <span class="md-ellipsis">
      预备知识
    </span>
  </a>
  
    <nav class="md-nav" aria-label="预备知识" hidden>
      <ul class="md-nav__list">
        
          <li class="md-nav__item ">
  <a href="#1" class="md-nav__link" >
    <span class="md-ellipsis">
      1. 持久化存储
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item ">
  <a href="#2" class="md-nav__link" >
    <span class="md-ellipsis">
      2. 交易验证
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item has-children">
  <a href="#_3" class="md-nav__link" onclick="toggleChildren(event)" aria-expanded="false">
    <span class="md-ellipsis">
      状态回滚
    </span>
  </a>
  
    <nav class="md-nav" aria-label="状态回滚" hidden>
      <ul class="md-nav__list">
        
          <li class="md-nav__item ">
  <a href="#1_1" class="md-nav__link" >
    <span class="md-ellipsis">
      1. 接收新区块后的状态回滚
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item ">
  <a href="#2_1" class="md-nav__link" >
    <span class="md-ellipsis">
      2. 生产区块后的状态回滚
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item ">
  <a href="#3" class="md-nav__link" >
    <span class="md-ellipsis">
      3. 分叉链的状态回滚
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item has-children">
  <a href="#_4" class="md-nav__link" onclick="toggleChildren(event)" aria-expanded="false">
    <span class="md-ellipsis">
      状态回滚的实现
    </span>
  </a>
  
    <nav class="md-nav" aria-label="状态回滚的实现" hidden>
      <ul class="md-nav__list">
        
          <li class="md-nav__item ">
  <a href="#1_2" class="md-nav__link" >
    <span class="md-ellipsis">
      1. 交易接收
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item ">
  <a href="#2_2" class="md-nav__link" >
    <span class="md-ellipsis">
      2. 收到新区块时的状态回滚
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item ">
  <a href="#3_1" class="md-nav__link" >
    <span class="md-ellipsis">
      3. 生产区块时的状态回滚
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item has-children">
  <a href="#_5" class="md-nav__link" onclick="toggleChildren(event)" aria-expanded="false">
    <span class="md-ellipsis">
      区块持久化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="区块持久化" hidden>
      <ul class="md-nav__list">
        
          <li class="md-nav__item ">
  <a href="#1_3" class="md-nav__link" >
    <span class="md-ellipsis">
      1. 数据库原子性
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item ">
  <a href="#_6" class="md-nav__link" >
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../network-module/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    网络
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Dapp开发
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Dapp开发
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contracts/tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  <span class="md-ellipsis">
    客户端
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            客户端
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../clients/wallet-cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    wallet-cli
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  <span class="md-ellipsis">
    版本发布
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            版本发布
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../releases/upgrade-instruction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    新版本部署手册
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../releases/signature_verification/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    一致性检验
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../releases/history/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    历史版本
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="">
            
  
  <span class="md-ellipsis">
    附录
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            附录
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../glossary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    术语表
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="chainbase-tron"><code>ChainBase</code> 模块：深入理解 TRON 的数据存储<a class="headerlink" href="#chainbase-tron" title="Permanent link">&para;</a></h1>
<h2 id="_1">概览<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>区块链本质上是一个不可篡改的分布式账本，其最大价值在于解决信任问题。在现实应用中，区块链被广泛用于记账和交易，例如许多应用通过比特币 (BTC)、以太坊 (ETH) 和 TRON 网络的 TRX 等数字货币进行经济活动，以确保资金流转的公开透明。</p>
<p>然而，实现这样一个不可篡改的分布式账本是一个极其复杂的系统工程，它涉及众多技术领域，包括 P2P 网络、智能合约、数据库、密码学和共识机制等。其中，数据库作为底层存储的核心组件，直接决定了系统的性能、可扩展性以及数据一致性，因此是区块链架构设计中的关键部分。</p>
<p>在 java-tron 中，数据库模块被称为 <code>ChainBase</code>。本文将围绕 <code>ChainBase</code> 模块，重点讲解以下核心机制：</p>
<ul>
<li><a href="#rollback">状态回滚</a>：在区块回滚、链分叉等场景下如何保证数据一致性</li>
<li><a href="#rollback-implementation">状态回滚的实现</a>：如何实现区块回滚</li>
<li><a href="#solidifying-block">区块持久化</a>：如何高效且可靠地将链上数据写入存储引擎，并保证数据一致性</li>
</ul>
<p>目标是帮助开发者更好地理解 <code>ChainBase</code> 的设计理念和实现细节，从而在开发 TRON 生态应用时更加得心应手。</p>
<h2 id="_2">预备知识<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>在区块链系统中，数据库是整个架构的核心之一，负责存储链上所有数据，包括：</p>
<ul>
<li>区块数据</li>
<li>交易记录</li>
<li>合约状态</li>
<li>账户信息</li>
<li>事件与日志</li>
</ul>
<p>每一个 TRON 全节点 都需要维护一份完整的数据副本，以保证在去中心化网络中实现一致性。</p>
<h3 id="1">1. 持久化存储<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p>与传统互联网应用相比，区块链数据库的设计有以下显著特征：</p>
<ul>
<li>高频读写：链上存在大量的 Key-Value 数据访问</li>
<li>数据不可篡改：历史数据一旦上链，不能被修改</li>
<li>高性能要求：交易量大，读写性能要求极高</li>
<li>可扩展性：需要适应不同规模的网络和节点部署场景，支持灵活扩展和存储优化策略。</li>
</ul>
<p>基于以上特点，java-tron 在数据库设计中采用了面向接口的架构，通过接口抽象，实现存储层与上层业务逻辑的解耦。这样做的好处是，开发者可以在不修改上层逻辑的情况下，灵活切换不同的底层存储引擎。</p>
<p>目前，<code>ChainBase</code> 支持以下两种主流存储引擎：</p>
<ul>
<li>LevelDB：轻量级嵌入式 Key-Value 存储</li>
<li>RocksDB：高性能、高并发的 Key-Value 存储</li>
</ul>
<p>这种架构既保证了系统的灵活性，又为后续支持更多存储后端提供了扩展能力。</p>
<h3 id="2">2. 交易验证<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p>在深入了解 <code>Chainbase</code> 模块之前，首先需要理解 java-tron 中交易的处理逻辑。</p>
<p><img alt="交易验证流程" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/chainbase_1.png" /></p>
<p>交易通过网络广播分发到各个节点。节点接收交易后，首先会对交易的签名进行校验。验证成功后，还需要对交易进行<strong>预执行</strong>，以此来判断该交易是否合法。</p>
<p>例如，一笔 A 向 B 转账 100 TRX 的交易，系统需验证 A 是否拥有足够余额。交易接收后，系统会尝试在本地数据库中执行余额扣减（A-100）与增加（B+100）。若操作成功，则该交易被认为在当前状态下是合法的，可进入打包流程。</p>
<p><a id="rollback"></a></p>
<h2 id="_3">状态回滚<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>如前所述，java-tron 通过<strong>预执行</strong>来验证交易的合法性。然而，某个交易在一个节点上验证成功，并不意味着该交易已成功上链，因为它尚未被打包到已共识的区块中，因此存在被回滚的风险。</p>
<p>java-tron 的共识遵循以下核心原则：只有被超过 2/3 的<strong>超级代表</strong>（<code>SR</code>）认可的区块中的交易，才是真正成功上链的交易。这可以理解为：</p>
<ul>
<li>交易被打包进入区块。</li>
<li>该区块被超过 2/3 的 <code>SR</code> 所接受。</li>
</ul>
<p>只有同时满足以上两点的交易，才被视为成功上链的交易。在 java-tron 中，一个交易被最终确认需要经历三个阶段：</p>
<ol>
<li><strong>交易校验</strong>：初步验证交易的合法性。</li>
<li><strong>交易打包进区块</strong>：交易被包含在一个待确认的区块中。</li>
<li><strong>该区块被网络大部分节点接收并应用</strong>：区块获得足够多的 <code>SR</code> 认可，成为固化块。</li>
</ol>
<p>这引出了一个关键问题：节点在验证交易后，更新了本地数据库，但若该交易未被打包进区块，或所在区块未获得超过 2/3 <code>SR</code> 的确认，该节点状态将在短时间内与整个网络产生不一致。</p>
<p>因此，<strong>除了被超过 2/3 <code>SR</code> 认可的区块中的交易数据外，所有因交易处理而产生的数据状态变化都有可能需要回滚</strong>。需要回滚的情况主要有以下三种：</p>
<ul>
<li><strong><a href="#rollback-1">接收到新的区块后</a></strong>，需回滚本地验证交易产生的状态变更。</li>
<li><strong><a href="#rollback-2">生产新区块后</a></strong>，需回滚交易验证产生的状态变更。</li>
<li><strong><a href="#rollback-3">出现链分叉时</a></strong>，需回滚旧主链区块并应用新主链区块。</li>
</ul>
<p>下面将逐一展开说明。</p>
<p><a id="rollback-1"></a></p>
<h3 id="1_1">1. 接收新区块后的状态回滚<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<p>当节点接收到新的区块时，需要将本地状态回滚到上一个区块结束时的状态，并回滚所有在此之后因交易验证而产生的状态变更。如下图所示：</p>
<p><img alt="接收新区块后的状态回滚" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/chainbase_2.png" /></p>
<p>如图所示：</p>
<ul>
<li>区块高度为 100 时，accountA 余额为 100；</li>
<li>节点预验证交易 t1：A 向 B 转账 100，成功执行；</li>
<li>随后收到新区块 block101，包含交易 t2：A 向 C 转账 50；</li>
<li>若不先回滚 t1，则因余额不足，t2 将校验失败。</li>
</ul>
<p>因此，需先撤销 t1 所引起的变更，回退至区块 100 的末状态，再执行 block101。</p>
<p><a id="rollback-2"></a></p>
<h3 id="2_1">2. 生产区块后的状态回滚<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<p>您可能会有疑问：在生产区块时，已经验证过的交易直接打包到区块中即可，为何还需要在生产区块前进行状态回滚？</p>
<p>java-tron 在将交易打包到区块时，需要对交易进行<strong>二次校验</strong>。进行二次校验的原因在于交易的时效性。仍然以上图为例，从图中可知在接收到区块 101 后，交易 <code>t1</code> 进行了回滚，并且 <code>accountA</code> 的余额减去了 50。之后轮到该节点打包出块，但此时 <code>t1</code> 已经变成一个非法的交易，因为 <code>accountA</code> 中的余额已经不足以支付 100 TRX。直接将 <code>t1</code> 打包进区块显然是不可取的，所以需要对交易再次进行校验。正因如此，才需要在出块前先将状态回滚。</p>
<p>当区块打包成功后，该节点会向网络广播该区块，同时也在本地 <code>apply</code> 该区块。而 <code>apply</code> 的逻辑则会对区块中的交易再次校验。因此，在打包完区块后，仍然需要执行回滚操作。</p>
<p><a id="rollback-3"></a></p>
<h3 id="3">3. 分叉链的状态回滚<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<p>在区块链运行过程中，不可避免地会出现分叉，尤其是在基于 DPoS 共识机制、出块速度较快的区块链系统中。当网络中出现多个区块候选链时，系统需要根据共识规则选择一条作为主链，其余链路则会被回滚并丢弃。</p>
<p>为实现这一过程，java-tron 会在内存中维护一个特定的数据结构（如下图所示），用于记录当前区块链的主链、分叉链及其对应的状态信息。</p>
<p><img alt="分叉链的状态回滚" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/chainbase_3.png" /></p>
<p>java-tron 会在内存中保存最近尚未达成最终共识的所有区块。当网络中出现分叉时，系统会根据<strong>最长链原则</strong>选择主链：如果某条分叉链的区块高度超过当前主链的高度，则会将该分叉链切换为新的主链。</p>
<p>切换过程如下：</p>
<ul>
<li>找到两条链的<strong>共同父区块</strong>（即分叉点）；</li>
<li>从当前主链回滚至该父区块，依次移除在此之后的主链区块；</li>
<li>从父区块开始，按顺序 <code>apply</code> 新主链上的区块数据。</li>
</ul>
<p>如上图所示，红色部分的 <code>Fork A</code> 原本是主链，但随着 <code>Fork B</code> 的高度不断增长，最终超过 <code>Fork A</code>。此时系统会回滚 <code>Fork A</code> 中高度为 103、102、101 的三个区块，然后依次 <code>apply</code> <code>Fork B</code> 中的 101、102、103、104 区块。</p>
<p><a id="rollback-implementation"></a></p>
<h2 id="_4">状态回滚的实现<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>本节将从代码层面讲解交易接收、交易验证、生成区块、验证区块和保存区块的流程，以进一步解析 <code>chainbase</code> 模块。</p>
<h3 id="1_2">1. 交易接收<a class="headerlink" href="#1_2" title="Permanent link">&para;</a></h3>
<p><img alt="交易接收流程" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/chainbase_4.png" /></p>
<ul>
<li>节点收到广播过来的交易后，通过 <code>Manager.pushTransaction(final TransactionCapsule trx)</code> 函数接收交易：将交易放入本地的 <code>pushTransactionQueue</code> 缓存队列，同时，对该交易进行验证。</li>
<li>验证通过后，交易进入 <code>pendingTransactionQueue</code>，供出块时使用。</li>
<li>若为 SR 节点，打包区块时会从中取出交易构建区块。</li>
</ul>
<p>验证失败处理：
* 来自 API：返回异常信息给用户
* 来自 P2P 网络：本地日志中记录错误</p>
<h3 id="2_2">2. 收到新区块时的状态回滚<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h3>
<p>在新区块抵达之前，节点可能已经收到了广播过来的交易，并对这些交易进行了验证。交易验证的过程会临时修改节点状态，以便判断交易是否能够正确执行。</p>
<p>然而，验证成功并不意味着交易最终一定会生效，因为交易还需要被打包进区块并完成固化。为保证状态一致性，当新区块到来时，节点会回滚之前因交易验证而产生的临时状态，只保留在 apply 区块过程中产生的状态变更。</p>
<p>节点在收到新区块之前，也可能收到广播过来的交易，这时，节点需要对接收到的交易进行验证，以判断该交易是否能正确执行。验证意味着需要改变状态，但验证成功的交易并不代表该交易最终一定能执行，它还需要经过打包进区块和固化的过程。因此，当新的区块到来时，这些交易验证所产生的状态都应该被回滚掉。</p>
<p><img alt="收到新区块时的状态回滚" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/chainbase_5.png" /></p>
<p>回滚时，需要将 <code>pendingTransactionQueue</code> 中的交易移至 <code>rePushTransactions</code>，并清空 <code>pendingTransactionQueue</code>。详细解释请参考上图。</p>
<p>为什么新的区块到来后需要清空 <code>pendingTransactionQueue</code>？首先明确一点，<code>pendingTransactionQueue</code> 队列负责在生成区块时提供交易数据，也就是说，它存放的是验证过的可以直接打包进区块的交易。但是，由于新区块也会对账户状态进行变更，可能导致 <code>pendingTransactionQueue</code> 中之前验证通过的交易在 <code>apply</code> 新区块后变得无效（最简单的例子：新区块中某笔交易是账户 A 花费了一部分 <code>token</code>，导致账户 A 在队列中的某笔交易金额不足以支付）。将交易移至 <code>rePushTransactions</code> 后，会有后台线程专门负责对该队列中的交易再次验证，如果没有问题，则再次放回 <code>pendingTransactionQueue</code>，为产生区块提供数据。</p>
<p>java-tron 中存在一个 <code>session</code> 对象，一个 <code>session</code> 表示一个区块对状态的变更。<code>session</code> 对象主要用于回滚，例如将状态回滚到上一个区块的状态都需要通过 <code>session</code> 来操作，如下图所示：</p>
<p><img alt="Session 对象与数据库" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/chainbase_6.png" /></p>
<p>上图显示了持久化存储中包含多种不同类型的数据库，这些数据共同组织成一个完整的区块链。例如，区块存储在 <code>khasodb</code> 和 <code>blockStore</code> 中，账户信息存储在 <code>accountStore</code> 中。</p>
<p>节点维护了一个 <code>session</code> 链表，该链表存储了区块/交易对应的变更信息，节点可以通过这些变更信息进行回退。上图中 <code>session1</code> 是当前最高区块对状态的变更。当接收到一个交易后，会产生一个新的 <code>session2</code>。后续每接收一个交易，都会产生一个临时的 <code>tmpSession</code>，该交易验证后，<code>tmpSession</code> 会立即合并到 <code>session2</code> 中。在再次接收到一个新区块之前，所有交易验证产生的状态变更都会保存在 <code>session2</code> 中。当有新区块到来时，直接执行 <code>session2</code> 的 <code>reset</code> 方法即可将状态回滚到上一个区块。</p>
<h3 id="3_1">3. 生产区块时的状态回滚<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<p><code>SR</code> 生产区块前需要回滚，原因比较复杂。我们先考虑一个场景：</p>
<ul>
<li><code>pendingTransactionQueue</code> 中存放的是当前已经验证过的交易，所以某个 <code>SR</code> 节点产块时，只要直接打包 <code>pendingTransactionQueue</code> 中的交易进区块，打包完成后将状态回滚到上一个区块的状态即可。</li>
</ul>
<p>但是这种方案存在一个问题：如果该 <code>SR</code> 节点刚刚接收并 <code>apply</code> 一个新的区块，从前面的内容可知 <code>pendingTransactionQueue</code> 将被清空至 <code>rePushTransactions</code>。此时如果正好轮到这个 <code>SR</code> 打包区块，但 <code>SR</code> 的 <code>pendingTransactionQueue</code> 中可能没有足够的交易。因此，真实的实现是，产块时不仅从 <code>pendingTransactionQueue</code> 读取交易，如果 <code>pendingTransactionQueue</code> 中交易较少，还会从 <code>rePushTransactions</code> 中读取交易来放入区块。而通过上面的分析可知，<code>rePushTransactions</code> 中的交易有可能已经不再有效，所以需要对交易再次进行验证。正是因为有这个验证逻辑，才需要在出块前先将状态回滚。</p>
<p><img alt="生产区块时的状态回滚" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/chainbase_7.png" /></p>
<p>在生产区块的过程中，会对交易再次验证，因此会产生状态变更。但这只是区块生成，还需要广播区块，由广播接收到的区块才会真正改变状态。所以，生成区块所产生的状态变更也需要被回滚掉。如上图所示，当区块生产完成后，还需要将 <code>session2''</code> 回滚掉。</p>
<p><a id="solidifying-block"></a></p>
<h2 id="_5">区块持久化<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p>java-tron 采用 DPoS 共识机制，通过投票选出 27 个超级代表（SR）作为出块节点，负责生产和确认区块。</p>
<p>当一个区块获得超过 2/3 <code>SR</code> 的认可，即超过 2/3 的超级代表基于该区块生成了后续区块时，该区块即视为已达成共识，不再发生回滚，称为 <strong>固化块</strong>（<code>Solidified Block</code>）。只有固化块才会被安全写入数据库。</p>
<p>在 Chainbase 模块中，<code>SnapshotManager</code> 扮演着核心角色，它作为存储层的统一入口，管理并维护所有业务数据库的引用。这些数据库引用被集中存放在一个列表中，每个数据库实例都支持基于自身新增一层临时状态集，即 <code>SnapshotImpl</code>。</p>
<p><code>SnapshotImpl</code> 本质上是一个内存中的 <code>HashMap</code>，多个 <code>SnapshotImpl</code> 之间通过链表结构进行关联。每个 <code>SnapshotImpl</code> 独立保存一次状态变更所涉及的数据修改，彼此之间相互隔离。借助这种链式快照结构，系统能够实现不同状态的独立管理与回滚控制，如下图所示：</p>
<p><img alt="SnapshotManager 结构" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/chainbase_8.png" /></p>
<p>在上图中，<code>SnapshotRoot</code> 是对底层持久化数据库的封装类，负责存储所有已固化的数据。</p>
<p>在前文我们提到过 <code>session</code> 的概念：一个 <code>session</code> 表示某个区块对全局状态的变更。实际上，一个 <code>session</code> 由多个数据库对应的 <code>SnapshotImpl</code> 组成。例如，在图中，区块 5 对应的所有 <code>SnapshotImpl</code> 共同构成了区块 5 的状态变更集合。</p>
<p>当节点接收到新区块时，其状态变更并不会立即写入持久化存储，而是首先记录在内存中的 <code>SnapshotImpl</code>。每接收一个区块，就会生成一个新的 <code>SnapshotImpl</code>。随着区块的不断到来，<code>SnapshotImpl</code> 的数量也会持续增加。</p>
<p>那么，这些内存中的快照（<code>SnapshotImpl</code>）何时会被真正写入持久化存储呢？</p>
<p>在 <code>SnapshotManager</code> 中有两个关键变量：</p>
<ul>
<li><code>size</code>：表示当前内存中 <code>SnapshotImpl</code> 的层数；</li>
<li><code>maxSize</code>：表示固化块高度与最新块高度之间的差值。</li>
</ul>
<p>当 <code>size</code> &gt; <code>maxSize</code> 时，意味着前面多出的 <code>size - maxSize</code> 层的<code>snapshotImpl</code> 对应的区块已经是固化块了，因此它们可以安全地落盘。此时，<code>SnapshotManager</code> 会将这些 <code>SnapshotImpl</code> 写入持久化数据库。</p>
<p>这种机制既避免了 <code>SnapshotImpl</code> 无限堆积导致的内存消耗，也确保了固化块能被及时、可靠地写入数据库。</p>
<h3 id="1_3">1. 数据库原子性<a class="headerlink" href="#1_3" title="Permanent link">&para;</a></h3>
<p>java-tron 的数据库存储设计与其他公链存在一定差异。以太坊在持久化层采用单一数据库实例，通过前缀区分不同类型的数据，并统一存储在同一个数据库中。而 java-tron 则采取了<strong>多数据库实例</strong>的设计思路，将不同业务的数据分别存放在独立的数据库实例中。</p>
<p>这两种实现方式各有优劣：</p>
<ul>
<li>单实例数据库：<ul>
<li>优点：维护简单，数据写入统一。</li>
<li>缺点：随着时间推移，单库数据量持续膨胀；某些业务的高频访问可能影响到其他业务的读写性能。</li>
</ul>
</li>
<li>多实例数据库：<ul>
<li>优点：不同业务的数据互不干扰，可针对不同数据库的数据规模和访问特征独立配置参数，从而实现性能优化；还可以将数据量庞大的库单独拆分，缓解膨胀问题。</li>
<li>缺点：缺乏原生的跨数据库原子写入支持，带来了事务一致性方面的挑战。</li>
</ul>
</li>
</ul>
<p>为了解决多数据库实例缺乏原子写入支持的问题，java-tron 引入了 检查点机制（<code>checkpoint mechanism</code>）。在将数据写入多个数据库实例之前，系统会先将所有待写入的数据统一记录到 <code>checkpoint</code> 中。如果在写入过程中发生异常，节点在服务重启时可以基于 <code>checkpoint</code> 恢复一致的数据状态，从而保证多实例写入的原子性。</p>
<p>在前一节中我们提到，固化块对应的 <code>snapshotImpl</code> 最终需要写入数据库，这一过程主要分为两步：</p>
<ol>
<li>创建 <code>checkpoint</code>
将内存中需要落盘的 <code>snapshotImpl</code> 统一持久化到一个临时数据库 <code>tmp</code>。</li>
<li>执行落盘操作
只有在 <code>checkpoint</code> 创建成功后，系统才会将对应的 <code>snapshotImpl</code> 正式写入各个业务数据库实例。</li>
</ol>
<p>在多实例数据库写入过程中，创建 <code>checkpoint</code> 是一个关键步骤。
<code>checkpoint</code> 的作用是：在数据真正落盘之前，先将内存中待写入数据库的 <code>snapshotImpl</code> 统一持久化到一个临时数据库（tmp 数据库。</p>
<p>只有在 <code>checkpoint</code> 创建成功之后，系统才会继续执行 <code>snapshotImpl</code> 的落盘操作。
如果此时在落盘过程中节点意外宕机，那么在节点重启时，系统会优先检查是否存在 <code>tmp</code> 的 <code>checkpoint</code> 数据：</p>
<ul>
<li>如果存在，则会将 <code>checkpoint</code> 中的数据回放至 <code>SnapshotRoot</code>，从而恢复一致的数据库状态。</li>
<li>如果不存在，则说明之前的数据已经安全落盘，节点可以直接继续执行。</li>
</ul>
<p><code>checkpoint</code> 的数据结构如下所示：</p>
<p><img alt="image" src="https://raw.githubusercontent.com/tronprotocol/documentation-zh/master/images/chainbase_9.png" /></p>
<p><code>checkpoint</code> 会将一次状态变更涉及的所有数据统一存放到一个临时数据库中，并通过前缀来区分不同类型的数据。为了确保所有数据能够完整落盘，写入时采用底层数据库提供的 <code>writeBatch()</code> 原子批量写入方式。</p>
<p>这一机制的核心思路可以总结为：</p>
<ul>
<li>多实例数据库之间缺乏原子写入保证，但单实例数据库（大多数主流数据库）通常支持原子性写入。</li>
<li>因此，系统先将需要原子写入的数据集统一写入到一个临时数据库（保证原子性），再从临时库将数据分发写入各个独立数据库实例。</li>
<li>如果写入过程中发生异常，节点可依靠临时库中的数据进行恢复，从而保证整体写入的一致性与可靠性。</li>
</ul>
<h2 id="_6">总结<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>本文结合交易与区块的处理流程，分析了 <code>ChainBase</code> 模块在 "状态回滚" 与 "数据库写入" 方面的实现机制。同时重点介绍了 java-tron 针对多数据库实例写入引入的 <code>checkpoint</code> 原子写入方案，如何在宕机等意外情况下有效防止数据库损坏。希望本文能帮助开发者更深入理解并更高效地参与 java-tron 数据库的开发与优化。</p>












		  <hr class="content-footer-divider">  <!-- 添加的水平线 -->
      	    	  <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../code-structure/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 模块结构">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                模块结构
              </div>
            </div>
          </a>
        
        
          
          <a href="../network-module/" class="md-footer__link md-footer__link--next" aria-label="Next: 网络">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                网络
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <!--div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div-->
</footer>
                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.footer", "toc.integrate", "search.highlight", "search.suggest", "content.code.annotate", "content.tooltips"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../javascripts/toc.js"></script>
      
        <script src="../../javascripts/nav-toc.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>